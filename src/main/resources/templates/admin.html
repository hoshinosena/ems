<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>admin</title>
    <link rel="stylesheet" type="text/css" href="css/user.css">
</head>
<body>
<div id="mask">
    <div id="loading" class="mask">
        <div style="top: 25%" class="fix1">
            <h1 style="font-size: 30px">
                <div style="text-align: center">Electricity Management System</div>
                <div style="text-align: center">Developed by 星野星奏</div>
                <div style="text-align: center">Powered by Vue</div>
            </h1>
        </div>
        <div style="top: 60%" class="fix1">
            <h2 style="text-align: center">Web Application Launching, please wait a moment</h2>
            <h2 style="text-align: center">ウェブアプリケーションを立ち上げ中、しばらくお待ちください</h2>
            <h2 style="text-align: center">网路应用程式启动中, 请稍等片刻</h2>
        </div>
        <div class="g-container fix2">
            <div id="proc"class="g-progress"></div>
        </div>
    </div>
</div>
<div id="container" class="container">
    <nav class="nav">
        <button class="action" @click="mainAction(0)">
            <div class="fix"><span class="font1">系统状态</span></div>
        </button>
        <button class="action" @click="mainAction(1)">
            <div class="fix"><span class="font1">用户管理</span></div>
        </button>
        <button class="action" @click="mainAction(2)">
            <div class="fix"><span class="font1">电费录入</span></div>
        </button>
        <button class="action" @click="mainAction(3)">
            <div class="fix"><span class="font1">操作记录</span></div>
        </button>
        <button class="action" @click="mainAction(4)">
            <div class="fix"><span class="font1">催缴清单</span></div>
        </button>
        <button class="action" @click="mainAction(5)">
            <div class="fix"><span class="font1">电价变更</span></div>
        </button>
        <button class="action" @click="logout">
            <div class="fix"><span class="font1">登出</span></div>
        </button>
        <button class="action" @click="about">
            <div class="fix"><span class="font1">关于</span></div>
        </button>
    </nav>
    <main class="main">
        <div class="left"></div>
        <div v-if="show == 0" class="middle">
            <div id="name"><h1 class="name">{{ name }}管理员</h1><h3 class="name">，{{ time < 6 ? "午夜好!" : time < 12 ? "早上好!" : time < 18 ? "下午好!" : "晚上好!" }}</h3><button style="float: right" @click="updateUnki" class="unki">{{ unki < 70 ? "末吉" : unki < 80 ? "小吉" : unki < 90 ? "中吉" : "大吉"}}({{ unki }})</button></div></br></br>
            <div id="function"><h3>{{ function1 }}</h3><h2>{{ function2 }}</h2></div></br></br>
            <div class="panel">
                </br>
                <div style="width: 100%">
                    <div style="height: 8%">&nbsp</div>
                    <h3 style="text-align: center">状态仪表盘</h3>
                    <div style="height: 8%">&nbsp</div>
                    <div>
                        <h4>现在时间: {{ now }}</h4>
                        <h4 style="left: 4.65em;position: relative">UTC/{{ timezone }}</h4>
                    </div>
                    <div style="height: 4%">&nbsp</div>
                    <div><h4>通讯时延: {{ delay }}</h4></div>
                    <div style="height: 4%">&nbsp</div>
                    <div><h4>在线人数: {{ tokens }}(活跃的Token计算)</h4></div>
                    <div style="height: 4%">&nbsp</div>
                    <div><h4>运行时间: {{ online }}</h4></div>
                    <div style="height: 4%">&nbsp</div>
                    <div style="display: flex">
                        <h4 style="width: 3em">CPU: </h4>
                        <div style="width: 10em;display: inline">
                            <div class="g-container">
                                <div class="g-progress" :style="{width: cpu}">&nbsp</div>
                            </div>
                        </div>
                    </div>
                    <div style="height: 4%">&nbsp</div>
                    <div style="display: flex">
                        <h4 style="width: 3em">MEM: </h4>
                        <div style="width: 10em;display: inline">
                            <div class="g-container">
                                <div class="g-progress" :style="{width: mem}">&nbsp</div>
                            </div>
                        </div>
                    </div>
                    <div style="height: 4%">&nbsp</div>
                    <div @mousemove="changeColor" :style="{background: `hsla(${color}, 100%, 50%, .5)`}" class="move">&nbsp</div>
                </div>
                <div style="height: 10%">&nbsp</div>
            </div>
        </div>
        <div v-if="show == 1" class="middle">
            <div style="text-align: center"><h1>用户管理</h1></div></br></br></br>
            <complex-table :page="page" :pages="pages" :users="users"></complex-table>
        </div>
        <div v-if="show == 2" class="middle">
            <div style="text-align: center"><h1>统一电费录入</h1></div></br></br>
            <div style="height: 2.83em;display: flex">
                <div style="width: 35%"></div>
                <div style="display: flex">
                    <div>
                        <div style="height: 20%"></div>
                        <h3>电价: {{ price }} 元/度</h3>
                    </div>
                </div>
            </div>
            <div style="display: flex">
                <div style="width: 35%"></div>
                <div style="width: 15em;display: flex">
                    <div style="width: 20%">
                        <div style="height: 20%"></div>
                        <h3>电力: </h3>
                    </div>
                    <div style="width: 20%"><input class="input input--block" placeholder="spend" v-model="spend"></div>
                    <div style="width: 12.5%"></div>
                    <div>
                        <div style="height: 20%"></div>
                        <div><h3> 度</h3></div>
                    </div>
                </div>
            </div>
            <div style="display: flex">
                <div style="width: 35%"></div>
                <div style="width: 15em;display: flex">
                    <div style="width: 20%">
                        <div style="height: 20%"></div>
                        <h3>编号: </h3>
                    </div>
                    <div style="width: 20%"><input class="input input--block" placeholder="spendUid" v-model="spendUid"></div>
                    <div style="width: 12.5%"></div>
                </div>
            </div>
            <div style="display: flex">
                <div style="width: 35%"></div>
                <div style="width: 15em;display: flex">
                    <div style="width: 20%">
                        <div style="height: 20%"></div>
                        <h3>备注: </h3>
                    </div>
                    <div style="width: 50%"><input class="input input--block" placeholder="info" v-model="spendInfo"></div>
                </div>
            </div>
            <div style="justify-content: center;align-items: center;display: flex">
                <div style="width: 20%">
                    <div style="left: 51%;position: relative"><div v-if="success" style="display: inline">
                        <div style="width: 12em;display: flex">
                            <div style="width: 20%">
                                <div style="height: 20%"></div>
                                <h3 :style="{background: `hsl(${color}, 100%, 50%)`}">成功</h3>
                            </div>
                        </div>
                    </div></div>
                </div>
                <div style="width: 30%">
                    <button class="button button--line" @click="addRecord">提交</button>
                </div>
            </div>
        </div>
        <div v-if="show == 3" class="middle">
            <div style="text-align: center"><h1>操作记录</h1></div></br></br>
            <div>
                <table class="table">
                    <thead>
                    <tr>
                        <td style="width: 10%">编号</td>
                        <td style="width: 25%">日期</td>
                        <td style="width: 33%">操作</td>
                        <td style="width: 20%">备注</td>
                        <td style="width: 12%">P表编号</td>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="item in records" :key="item.rid">
                        <td>{{ item.rid }}</td>
                        <td>{{ item.date }}</td>
<!--                        自定义组件使用-->
<!--                        每一个自定义组件可以看作是一个vue实例-->
<!--                        每个实例使用ajax实现异步执行-->
                        <td is="vue:async-comp" :item="item"></td>
                        <td>{{ item.info }}</td>
                        <td>{{ item.pid }}</td>
                    </tr>
                    </tbody>
                </table>
            </div></br>
            <div style=";display: flex">
                <div style="width: 5%"></div>
                <div style="width: 15%"><button style="width: 90%;float: left" class="button button--line" @click="turn(0)">首页</button></div>
                <div style="width: 20%"><button style="width: 99%;float: left" class="button button--line" @click="turn(1)">上一页</button></div>
                <div style="width: 20%;display: flex"><h3 style="width: 45%;text-align: right">{{ page }}</h3>/<h2 style="width: 45%;text-align: left">{{ pages }}</h2></div>
                <div style="width: 20%"><button style="width: 99%;float: right" class="button button--line" @click="turn(2)">下一页</button></div>
                <div style="width: 15%"><button style="width: 90%;float: right" class="button button--line" @click="turn(3)">尾页</button></div>
                <div style="width: 5%"></div>
            </div>
        </div>
        <div v-if="show == 4" class="middle">
            <div style="text-align: center"><h1>催交清单</h1></div></br></br></br>
            <div>
                <div>
                    <div style="display: flex">
                        <div style="width: 15em;display: flex">
                            <div style="width: 37.5%">
                                <div style="height: 20%"></div>
                                <h3>金额小于: </h3>
                            </div>
                            <div style="width: 20%"><input class="input input--block" placeholder="money" :value="money" @input="autoFlash($event)"></div>
                            <div style="width: 12.5%"></div>
                            <div>
                                <div style="height: 20%"></div>
                                <div><h3> 元</h3></div>
                            </div>
                        </div>
                    </div>
                    <button style="width: 15em" class="button button--line" @click="getUserByMoney">导出所有数据</button>
                </div>
                <div>
                    <table class="table">
                        <thead>
                        <tr>
                            <td style="width: 8%">编号</td>
                            <td style="width: 12%">名前</td>
                            <td style="width: 15%">用户名</td>
                            <td style="width: 12%">余额</td>
                            <td style="width: 15%">电话</td>
                            <td style="width: 20%">地址</td>
                            <td style="width: 12%">备注</td>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in users" :key="item.uid">
                            <td>{{ item.uid }}</td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.username }}</td>
                            <td>{{ item.money }}</td>
                            <td>{{ item.tel }}</td>
                            <td>{{ item.address }}</td>
                            <td>{{ item.info }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div></br>
                <div style=";display: flex">
                    <div style="width: 5%"></div>
                    <div style="width: 15%"><button style="width: 90%;float: left" class="button button--line" @click="turn(0)">首页</button></div>
                    <div style="width: 20%"><button style="width: 99%;float: left" class="button button--line" @click="turn(1)">上一页</button></div>
                    <div style="width: 20%;display: flex"><h3 style="width: 45%;text-align: right">{{ page }}</h3>/<h2 style="width: 45%;text-align: left">{{ pages }}</h2></div>
                    <div style="width: 20%"><button style="width: 99%;float: right" class="button button--line" @click="turn(2)">下一页</button></div>
                    <div style="width: 15%"><button style="width: 90%;float: right" class="button button--line" @click="turn(3)">尾页</button></div>
                    <div style="width: 5%"></div>
                </div>
            </div>
        </div>
        <div v-if="show == 5" class="middle">
            <div style="text-align: center"><h1>电价变更</h1></div></br></br>
            <div>
                <div>
                    <button style="width: 15%" class="button button--line" @click="addPrice">变更</button>
                </div>
                <div>
                    <table class="table">
                        <thead>
                        <tr>
                            <td style="width: 8%">编号</td>
                            <td style="width: 20%">日期</td>
                            <td style="width: 10%">价格</td>
                            <td style="width: 30%">备注</td>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="item in eprices" :key="item.pid">
                            <td>{{ item.pid }}</td>
                            <td>{{ item.date }}</td>
                            <td>{{ item.price }}</td>
                            <td>{{ item.info }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div style=";display: flex">
                    <div style="width: 5%"></div>
                    <div style="width: 15%"><button style="width: 90%;float: left" class="button button--line" @click="turn(0)">首页</button></div>
                    <div style="width: 20%"><button style="width: 99%;float: left" class="button button--line" @click="turn(1)">上一页</button></div>
                    <div style="width: 20%;display: flex"><h3 style="width: 45%;text-align: right">{{ page }}</h3>/<h2 style="width: 45%;text-align: left">{{ pages }}</h2></div>
                    <div style="width: 20%"><button style="width: 99%;float: right" class="button button--line" @click="turn(2)">下一页</button></div>
                    <div style="width: 15%"><button style="width: 90%;float: right" class="button button--line" @click="turn(3)">尾页</button></div>
                    <div style="width: 5%"></div>
                </div>
            </div>
        </div>
        <div class="right"></div>
<!--        hidden使用阻止渲染提高性能(虽然排版上不使用hidden也是看不见的)-->
        <data hidden id="data">
            <div>
                <table class="table">
                    <thead>
                    <tr>
                        <td style="width: 8%">编号</td>
                        <td style="width: 12%">名前</td>
                        <td style="width: 15%">用户名</td>
                        <td style="width: 12%">余额</td>
                        <td style="width: 15%">电话</td>
                        <td style="width: 20%">地址</td>
                        <td style="width: 12%">备注</td>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="item in usersByMoney" :key="item.uid">
                        <td>{{ item.uid }}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.username }}</td>
                        <td>{{ item.money }}</td>
                        <td>{{ item.tel }}</td>
                        <td>{{ item.address }}</td>
                        <td>{{ item.info }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </data>
    </main>
</div>

<script>
    var startTime = new Date().getTime();
    var flag = window.setInterval(() => {
        var t = new Date().getTime()
        if (t < startTime + 1000) {
            document.getElementById("proc").style.width = (t - startTime) * 0.02 + "%";
        }
    }, 10);
    window.onload = () => {
        var flag1 = window.setInterval(() => {
            if (startTime + 1400 < new Date().getTime()) {
                clearInterval(flag);
                clearInterval(flag1);
                startTime = new Date().getTime();
                flag1 = window.setInterval(() => {
                    var t = new Date().getTime();
                    if (startTime + 1000 < t) {
                        clearInterval(flag1);
                        document.getElementById("mask").innerHTML = "";
                    } else {
                        t -= startTime;
                        // 应为0.00005 * t ** 2 + 0.03 * t + 20)
                        // 进度条样式延时0.2s需要修正
                        document.getElementById("proc").style.width = (0.00005 * t ** 2 + 0.03 * t + 40)+ "%";
                    }
                }, 10);
            }
        }, 10)
    }
</script>
<link rel="stylesheet" type="text/css" href="css/generation.css">
<link rel="stylesheet" type="text/css" href="css/admin.css">
<link rel="stylesheet" type="text/css" href="css/jquery-confirm-min.css">
<script src="js/jquery-1.9.1-min.js"></script>
<script src="js/jquery.cookie-1.4.1-min.js"></script>
<script src="js/jquery-confirm-min.js"></script>
<script src="js/vue-3.3.4-global-min.js"></script>
<script src="js/utils.js"></script>
<script src="js/api.js"></script>
<script>
    var baseURL = API.baseURL = $.cookie("baseURL");
    var { createApp } = Vue;
    var app;
    var container = createApp({
        data() {
            return {
                "function1": "一部不具合的状况发生, 机能异常",
                "function2": "抱歉, EMS系统未能正常启动:(",
                "now": Utils.getTime("yyyy-MM-dd hh:mm:ss"),
                "timezone": "GMT+0900(日本标准时间)",
                "delay": 0,
                "tokens": 0,
                "online": 0,
                "cpu": 0,
                "mem": 0,
                "color": 0,
                "username": $.cookie("username"),
                "name": $.cookie("name"),
                "time": new Date().getHours(),
                "unki": RandomUtil.randomInt(100),
                "users": [],
                "records": [],
                "eprices": [],
                "price": 0,
                "spend": "",
                "spendUid": "",
                "spendInfo": "统一电费录入",
                "success": false,
                "money": 0,
                "usersByMoney": [],
                "pagedata" : "users",
                "selectContent": null,
                "page": 1,
                "pages": 1,
                "show": 0,
            }
        },
        methods: {
            getSystemInfo() {
                var startTime = new Date().getTime();
                $.ajax({
                    type: "POST",
                    url: baseURL + "system/get",
                    contentType: "application/json",
                    data: JSON.stringify({"token": $.cookie("token")}),
                    dataType: "json"
                }).always(function(data) {
                    if (data.code === 0) {
                        var now = new Date().getTime();
                        // 时钟不同步 不使用伺服器下发的时间戳
                        // var delay = now - data.time;
                        // 使用RTT/2估算，需要注意setInterval的1秒时延
                        // RTT / 2 = (now - startTime - 1000) / 2
                        var delay = Math.floor((now - startTime - 1000) / 2);
                        var online = Utils.getTime("MM月dd天hh时mm分ss秒", now - data.start);
                        app.delay = (delay < 60 ? "优" : delay < 150 ? "良" : delay < 400 ? "一般" : "差") + "(" + delay + "ms)";
                        while (online.substring(0, 2) === "00") {
                            online = online.substring(3);
                        }
                        app.online = online;
                        app.tokens = data.tokens;
                        app.cpu = Math.floor(data.cpu * 100) / 100 + "%";
                        app.mem = Math.floor(data.mem * 100) / 100 + "%";
                    } else {
                        app.delay = "失去连接";
                        app.tokens = 0;
                        app.online = 0;
                        app.cpu = "0%";
                        app.mem = "0%";
                    }
                })
                this.now = Utils.getTime("yyyy-MM-dd hh:mm:ss");
            },
            updateUnki() {
                var rand = 0;
                while (rand < 70) {
                    rand = RandomUtil.randomInt(100);
                }
                this.unki = rand;
                this.color = RandomUtil.randomInt(360);
            },
            changeColor(event) {
                this.color = RandomUtil.randomInt(360);
            },
            mainAction(todo) {
                this.show = todo;
                if (todo === 0) {
                    this.time = new Date().getHours();
                }
                if (todo === 1) { // 用户管理数据(所有)
                    // this.getUser(null, null, null, 1);
                    this.pagedata = "users";
                    this.turn(0);
                } else if (todo === 2) {
                    this.success = false;
                    this.price = API.getPrice(true).price.price;
                } else if (todo === 3) { // 历史记录数据
                    this.pagedata = "records";
                    this.turn(0);
                } else if (todo === 4) {
                    this.pagedata = "selectByMoney";
                    this.turn(0);
                } else if (todo === 5) {
                    this.pagedata = "eprices";
                    this.turn(0);
                }
                if (todo !== 2) { // 清除电费录入提交数据
                    this.spend = "";
                    this.spendUid = "";
                    this.spendInfo = "统一电费录入";
                }
                if (todo !== 4) { // 清除催交清单提及数据
                    this.money = 0;
                }
            },
            getUserDetail(uid) {
                var result = API.getUser(uid, null, null, null);
                if (result.code === 0) {
                    var user = result.user;
                    $.dialog({
                        title: "用户详细信息",
                        content: "<div>" +
                            "<div><h3>电话: " + user.tel + "</h3></div>" +
                            "<div><h3>地址: " + user.address + "</h3></div>" +
                            "<div><h3>备注: " + user.info + "</h3></div>" +
                            "</div>",
                        boxWidth: "45%",
                        useBootstrap: false,
                        theme: "material",
                        animationBounce: 1.5
                    })
                } else {
                    $.dialog({
                        title: "通讯异常",
                        content: "<h4>错误代码: " + result.code + "</h4><h4>错误原因: " + result.message + "</h4>",
                        boxWidth: "45%",
                        useBootstrap: false,
                        theme: "material",
                        animationBounce: 1.5
                    })
                }
            },
            getUserByMoney() {
                var result = API.getUser(null, null, this.money, null);
                if (result.code === 0) {
                    this.usersByMoney = result.users;
                    // Vue更新DOM后再弹窗
                    Vue.nextTick(function() {
                        $.dialog({
                            title: "文稿与数据",
                            content: document.getElementById("data").innerHTML,
                            onClose: function() {
                                app.usersByMoney = [];
                            },
                            boxWidth: "60%",
                            useBootstrap: false,
                            theme: "material",
                            animationBounce: 1.5
                        })
                    })
                } else {
                    $.dialog({
                        title: "通讯异常",
                        content: "<h4>错误代码: " + result.code + "</h4><h4>错误原因: " + result.message + "</h4>",
                        boxWidth: "45%",
                        useBootstrap: false,
                        theme: "material",
                        animationBounce: 1.5
                    })
                }
            },
            findUser() {
                $.confirm({
                    title: "查找方式",
                    content: "<div style='display: flex;align-items: center'><h3 style='display: inline'>根据</h3>" +
                        "<select id='selectBy' style='display: inline'>" +
                            "<option value='name'>名前</option>" +
                            "<option value='uid'>Uid</option>" +
                            // "<option value='username'>用户名</option>" +
                        "</select><h3 style='display: inline'>查询</h3><input id='content' style='width: 30%;display: inline'>" +
                        "</div>",
                    buttons: {
                        confirm: {
                            text: "执行",
                            action: function() {
                                var selectBy = this.$content.find("#selectBy").val();
                                var content = this.$content.find("#content").val();
                                if (selectBy === "name") {
                                    app.pagedata = "selectByName"
                                } else if (selectBy === "uid") {
                                    app.pagedata = "selectByUid"
                                }
                                app.selectContent = content;
                                app.turn(0);
                            }
                        },
                        cancel: {
                            text: "取消"
                        }
                    },
                    boxWidth: "30%",
                    useBootstrap: false,
                    theme: "material",
                    animationBounce: 1.5
                })
            },
            addUser() {
                $.confirm({
                    title: "添加用户",
                    content: "<div>" +
                        "<div><h3 id='1' style='display: inline'>账号: </h3><input id='addUsername' style='width: 40%;display: inline'></div>" +
                        "<div><h3 style='display: inline'>密码: </h3><input id='addPassword' style='width: 40%;display: inline'></div>" +
                        "<div><h3 style='display: inline'>名前: </h3><input id='addName' style='width: 40%;display: inline'></div>" +
                        "<div><h3 style='display: inline'>身份: </h3><select id='addRole'><option value='user'>用户</option><option value='admin'>管理员</option></select></div>" +
                        "</div>",
                    buttons: {
                        confirm: {
                            text: "确认",
                            action: function() {
                                var user = {};
                                var result;
                                user.username = this.$content.find("#addUsername").val();
                                user.password = this.$content.find("#addPassword").val();
                                user.name = this.$content.find("#addName").val();
                                user.role = this.$content.find("#addRole").val();
                                result = API.addUser(user);
                                if (result.code === 0) {
                                    $.alert({
                                        title: "添加成功",
                                        content: "数据已提交并被接受",
                                        buttons: {
                                            ok: {
                                                text: "好"
                                            }
                                        },
                                        boxWidth: "30%",
                                        useBootstrap: false,
                                        theme: "material",
                                        animationBounce: 1.5
                                    });
                                    // app.getUser(null, null, null, app.page);
                                    app.turn(app.page);
                                } else {
                                    $.alert({
                                        title: "添加失败",
                                        content: "<h4>错误代码: " + result.code + "</h4><h4>错误原因: " + result.message + "</h4>",
                                        buttons: {
                                            ok: {
                                                text: "好"
                                            }
                                        },
                                        boxWidth: "30%",
                                        useBootstrap: false,
                                        theme: "material",
                                        animationBounce: 1.5
                                    });
                                }
                            }
                        },
                        cancel: {
                            text: "取消"
                        }
                    },
                    boxWidth: "30%",
                    useBootstrap: false,
                    theme: "material",
                    animationBounce: 1.5
                })
            },
            updUser(uid) {
                var result = API.getUser(uid, null, null, null);
                var user
                if (result.code === 0) {
                    user = result.user;
                    $.confirm({
                        title: "修改用户",
                        content: "<div>" +
                            "<div><h3 id='1' style='display: inline'>编号: </h3><input value='" + user.uid + "' id='addUid' style='width: 40%;display: inline' readonly></div>" +
                            "<div><h3 style='display: inline'>身份: </h3><select id='addRole'><option " + (user.role === "user" ? "selected" : "") + " value='user'>用户</option><option " + (user.role === "admin" ? "selected" : "") + " value='admin'>管理员</option></select></div>" +
                            "<div><h3 id='1' style='display: inline'>账号: </h3><input value='" + user.username + "' id='addUsername' style='width: 40%;display: inline' readonly></div>" +
                            "<div><h3 style='display: inline'>密码: </h3><input id='addPassword' style='width: 40%;display: inline'></div>" +
                            "<div><h3 style='display: inline'>名前: </h3><input value='" + user.name + "' id='addName' style='width: 40%;display: inline'></div>" +
                            "<div><h3 style='display: inline'>余额: </h3><input value='" + user.money + "' id='addMoney' style='width: 40%;display: inline'></div>" +
                            "<div><h3 style='display: inline'>电话: </h3><input value='" + user.tel + "' id='addTel' style='width: 40%;display: inline'></div>" +
                            "<div><h3 style='display: inline'>地址: </h3><input value='" + user.address + "' id='addAddress' style='width: 40%;display: inline'></div>" +
                            "<div><h3 style='display: inline'>备注: </h3><input value='" + user.info + "' id='addInfo' style='width: 40%;display: inline'></div>" +
                            "</div>",
                        buttons: {
                            confirm: {
                                text: "确认",
                                action: function() {
                                    var result;
                                    user.role = this.$content.find("#addRole").val();
                                    user.password = this.$content.find("#addPassword").val();
                                    user.name = this.$content.find("#addName").val();
                                    // 浮点数不能使用===
                                    user.money = (user.money == this.$content.find("#addMoney").val()) ? null : this.$content.find("#addMoney").val();
                                    user.tel = this.$content.find("#addTel").val();
                                    user.address = this.$content.find("#addAddress").val();
                                    user.info = this.$content.find("#addInfo").val();
                                    result = API.updateUser(user);
                                    if (result.code === 0) {
                                        $.alert({
                                            title: "修改成功",
                                            content: "数据已提交并被接受",
                                            buttons: {
                                                ok: {
                                                    text: "好"
                                                }
                                            },
                                            boxWidth: "30%",
                                            useBootstrap: false,
                                            theme: "material",
                                            animationBounce: 1.5
                                        });
                                        // app.getUser(null, null, null, app.page);
                                        app.turn(app.page);
                                    } else {
                                        $.alert({
                                            title: "修改失败",
                                            content: "<h4>错误代码: " + result.code + "</h4><h4>错误原因: " + result.message + "</h4>",
                                            buttons: {
                                                ok: {
                                                    text: "好"
                                                }
                                            },
                                            boxWidth: "30%",
                                            useBootstrap: false,
                                            theme: "material",
                                            animationBounce: 1.5
                                        });
                                    }
                                }
                            },
                            cancel: {
                                text: "取消"
                            }
                        },
                        boxWidth: "30%",
                        useBootstrap: false,
                        theme: "material",
                        animationBounce: 1.5,
                    })
                }
            },
            // 此函数于1.2.1因合并入复杂组件(complex-table)
            // 实现批量删除已被废弃
            delUser(uid, name) {
                $.confirm({
                    title: "删除用户",
                    content: "<div style='width: 100%'>" +
                        "<div style='width: 100%'><h3 style='display: inline'>这将</h3><h2 style='color: red;display: inline'>不可逆</h2><h3 style='display: inline'>地删除"+ name +"(Uid: " + uid + ")</h3></div>" +
                        "<div><h3>确认要继续执行吗?</h3></div>" +
                        "</div>",
                    buttons: {
                        confirm: {
                            text: "删除",
                            btnClass: "btn-red",
                            action: function() {
                                var result = API.deleteUser(uid);
                                if (result.code === 0) {
                                    $.alert({
                                        title: "删除成功",
                                        content: "数据已提交并被接受",
                                        buttons: {
                                            ok: {
                                                text: "好"
                                            }
                                        },
                                        boxWidth: "30%",
                                        useBootstrap: false,
                                        theme: "material",
                                        animationBounce: 1.5
                                    });
                                    // app.getUser(null, null, null, app.page);
                                    app.turn(app.page);
                                } else {
                                    $.alert({
                                        title: "删除失败",
                                        content: "<h4>错误代码: " + result.code + "</h4><h4>错误原因: " + result.message + "</h4>",
                                        buttons: {
                                            ok: {
                                                text: "好"
                                            }
                                        },
                                        boxWidth: "30%",
                                        useBootstrap: false,
                                        theme: "material",
                                        animationBounce: 1.5
                                    });
                                }
                            }
                        },
                        cancel: {
                            text: "取消"
                        }
                    },
                    boxWidth: "30%",
                    useBootstrap: false,
                    theme: "material",
                    animationBounce: 1.5,
                })
            },
            addRecord() {
                var record = {};
                var result;
                record.uid = this.spendUid;
                record.changes = this.spend;
                record.info = this.spendInfo;
                result = API.addRecord(record);
                if (result.code === 0) {
                    this.success = true;
                    this.changeColor(null);
                } else {
                    this.success = false;
                }
            },
            addPrice() {
                $.confirm({
                    title: "变更价格",
                    content: "<div>" +
                        "<div><h3 id='1' style='display: inline'>新价格: </h3><input id='addPrice' style='width: 20%'></div>" +
                        "<div><h3 id='1' style='display: inline'>备注&nbsp&nbsp&nbsp: </h3><input id='addInfo' style='width: 40%'></div>" +
                        "</div>",
                    buttons: {
                        confirm: {
                            text: "确认",
                            action: function() {
                                var eprice = {};
                                var result;
                                eprice.price = this.$content.find("#addPrice").val();
                                eprice.info = this.$content.find("#addInfo").val();
                                result = API.addPrice(eprice);
                                if (result.code === 0) {
                                    $.alert({
                                        title: "变更成功",
                                        content: "数据已提交并被接受",
                                        buttons: {
                                            ok: {
                                                text: "好"
                                            }
                                        },
                                        boxWidth: "30%",
                                        useBootstrap: false,
                                        theme: "material",
                                        animationBounce: 1.5
                                    });
                                    app.turn(app.page);
                                } else {
                                    $.alert({
                                        title: "变更失败",
                                        content: "<h4>错误代码: " + result.code + "</h4><h4>错误原因: " + result.message + "</h4>",
                                        buttons: {
                                            ok: {
                                                text: "好"
                                            }
                                        },
                                        boxWidth: "30%",
                                        useBootstrap: false,
                                        theme: "material",
                                        animationBounce: 1.5
                                    });
                                }
                            }
                        },
                        cancel: {
                            text: "取消"
                        }
                    },
                    boxWidth: "30%",
                    useBootstrap: false,
                    theme: "material",
                    animationBounce: 1.5
                })
            },
            autoFlash(event) {
                this.money = event.target.value;
                this.turn(4);
            },
            turn(todo) {
                var num;
                if (todo === 0) {
                    num = 1;
                } else if (todo === 1) {
                    num = this.page - 1;
                } else if (todo === 2) {
                    num = this.page + 1;
                } else if (todo === 3) {
                    num = this.pages;
                } else {
                    num = this.page;
                }
                if (this.pagedata === "users") {
                    API.getUser(null, null, null, num, (result) => {
                        if (result.code === 0) {
                            app.page = result.page;
                            app.pages = result.pages;
                            app.users = result.users;
                        }
                    })
                } else if (this.pagedata === "selectByName") {
                    API.getUser(null, this.selectContent, null, num, (result) => {
                        if (result.code === 0) {
                            app.page = result.page;
                            app.pages = result.pages;
                            app.users = result.users;
                        }
                    })
                }  else if (this.pagedata === "selectByUid") {
                    API.getUser(this.selectContent, null, null, num, (result) => {
                        if (result.code === 0) {
                            app.page = 1;
                            app.pages = 1;
                            app.users = result.user === null ? [] : [result.user];
                        }
                    })
                } else if (this.pagedata === "selectByMoney") {
                    API.getUser(null, null, this.money, num, (result) => {
                        if (result.code === 0) {
                            app.page = result.page;
                            app.pages = result.pages;
                            app.users = result.users;
                        }
                    })
                } else if  (this.pagedata === "eprices") {
                    API.getPrice(false, num, (result) => {
                        if (result.code === 0) {
                            app.page = result.page;
                            app.pages = result.pages;
                            app.eprices = result.prices;
                        }
                    })
                } else {
                    API.getRecords(num, (result) => {
                        if (result.code === 0) {
                            app.page = result.page;
                            app.pages = result.pages;
                            app.records = result.records;
                        }
                    })
                }
            },
            logout() {
                $.ajax({
                    type: "POST",
                    url: baseURL + "to_logout",
                    // 阻塞线程避免登出数据与
                    // 访问根的请求到达次序不同
                    async: false
                });
                var keys = document.cookie.match(/[^ =;]+(?=\=)/g);
                if (keys) {
                    for (var i = keys.length; i--;)
                        document.cookie = keys[i] + '=0;expires=' + new Date(0).toUTCString() + ";path=/;";
                }
                sessionStorage.clear();
                window.location.href = baseURL;
            },
            about() {
                window.open(baseURL + "about.html");
            }
        },
        mounted() {
            var t;
            app = this;
            this.updateUnki();
            t = (new Date() + "").split(" ");
            this.timezone = t[t.length - 2] + t[t.length - 1];
            this.getSystemInfo();
        },
        components: {
            "async-comp": {
                props: ["item"],
                template: "<td>{{ result }}</td>",
                data() {
                    return {
                        "result": ""
                    }
                },
                mounted() {
                    var temp = this;
                    $.ajax({
                        type: "POST",
                        url: baseURL + "api/user/get",
                        contentType: "application/json",
                        data: JSON.stringify({
                            "token": $.cookie("token"),
                            "uid": temp.item.uid,
                        }),
                        dataType: "json",
                        success: function(data) {
                            var name = data.user.name;
                            var item = temp.item;
                            temp.result = (item.op === 0 ? "管理员修改" + name +"(uid: " + item.uid + ")的余额为"
                                : item.op === 1 ? name + "(uid: " + item.uid + ")充值"
                                    : name + "(uid: " + item.uid + ")消费" ) + item.changes + "元";
                        }
                    })
                }
            },
            "complex-table": {
                props: ["page", "pages", "users"],
                template: "            <div>\n" +
                    "                <button style=\"width: 15%\" class=\"button button--line\" @click=\"addUser\">添加</button>\n" +
                    "                <div style=\"width: 10%;display: inline\">&nbsp</div>\n" +
                    "                <button style=\"width: 15%\" class=\"button button--line\" @click=\"findUser\">查找</button>\n" +
                    "                <button style=\"width: 15%;float:right\" class=\"button button--line\" @click=\"delSelectUsers\">删除</button>\n" +
                    "            </div>\n" +
                    "            <div>\n" +
                    "                <table class=\"table\">\n" +
                    "                    <thead>\n" +
                    "                    <tr>\n" +
                    "                        <td style=\"width: 4%\"><input id=\"s-all\" type=\"checkbox\" style=\"opacity: 50%\" @click=\"select(-1)\"></td>\n" +
                    "                        <td style=\"width: 10%\">编号</td>\n" +
                    "                        <td style=\"width: 16%\">用户名</td>\n" +
                    "                        <td style=\"width: 13%\">身份</td>\n" +
                    "                        <td style=\"width: 16%\">名前</td>\n" +
                    "                        <td style=\"width: 15%\">余额</td>\n" +
                    "                        <td style=\"width: 14%\">详细信息</td>\n" +
                    "                        <td style=\"width: 12%\">操作</td>\n" +
                    "                    </tr>\n" +
                    "                    </thead>\n" +
                    "                    <tbody>\n" +
                    "                    <tr v-for=\"item in users\" :key=\"item.uid\">\n" +
                    "                        <td><input :id=\"'s-' + item.uid\" type=\"checkbox\" style=\"opacity: 50%\" @click=\"select(item.uid)\"></td>\n" +
                    "                        <td>{{ item.uid }}</td>\n" +
                    "                        <td>{{ item.username }}</td>\n" +
                    "                        <td>{{ item.role }}</td>\n" +
                    "                        <td>{{ item.name }}</td>\n" +
                    "                        <td>{{ item.money }}</td>\n" +
                    "                        <td><a href=\"javascript:void(0)\" @click=\"getUserDetail(item.uid)\">查看</a></td>\n" +
                    "                        <td>\n" +
                    "                            <div style=\"width: 5%; float: left\"></div>\n" +
                    "                            <a href=\"javascript:void(0)\" @click=\"updUser(item.uid)\">修改</a>\n" +
                    "                            <div style=\"width: 5%;float: right\"></div>\n" +
                    "                        </td>\n" +
                    "                    </tr>\n" +
                    "                    </tbody>\n" +
                    "                </table>\n" +
                    "            </div>" +
                    "            <div style=\";display: flex\">\n" +
                    "                <div style=\"width: 5%\"></div>\n" +
                    "                <div style=\"width: 15%\"><button style=\"width: 90%;float: left\" class=\"button button--line\" @click=\"turn(0)\">首页</button></div>\n" +
                    "                <div style=\"width: 20%\"><button style=\"width: 99%;float: left\" class=\"button button--line\" @click=\"turn(1)\">上一页</button></div>\n" +
                    "                <div style=\"width: 20%;display: flex\"><h3 style=\"width: 45%;text-align: right\">{{ page }}</h3>/<h2 style=\"width: 45%;text-align: left\">{{ pages }}</h2></div>\n" +
                    "                <div style=\"width: 20%\"><button style=\"width: 99%;float: right\" class=\"button button--line\" @click=\"turn(2)\">下一页</button></div>\n" +
                    "                <div style=\"width: 15%\"><button style=\"width: 90%;float: right\" class=\"button button--line\" @click=\"turn(3)\">尾页</button></div>\n" +
                    "                <div style=\"width: 5%\"></div>\n" +
                    "            </div>" +
                    "            <data hidden id='s-data'>" +
                    "            <div style='width: 100%'>" +
                    "            <div v-for=\"item in selectedUsers\"><h4>&nbsp&nbsp&nbsp{{ item.role == 'admin' ? '管理员' : '用户&nbsp&nbsp&nbsp'}} {{ item.name }}(uid: {{ item.uid }}) <span v-if=\"item.result == '' || item.result == '删除成功'\">{{ item.result }}</span><span v-else style=\"color: red\">{{ item.result }}</span></h4></div>" +
                    "            </div>" +
                    "            </data>",
                data() {
                    return {
                        "selectedUsers": [],
                        "delResult": []
                    }
                },
                methods: {
                    addUser() {
                        app.addUser();
                    },
                    findUser() {
                        app.findUser();
                    },
                    select(uid) {
                        if (uid === -1) {
                            if (this.selectedUsers.length === this.users.length) {
                                this.selectedUsers = [];
                                for (var i = 0; i < this.users.length; i++) {
                                    uid = this.users[i].uid;
                                    document.getElementById("s-" + uid).checked = false;
                                }
                            } else {
                                this.selectedUsers = [];
                                for (var i = 0; i < this.users.length; i++) {
                                    uid = this.users[i].uid;
                                    var name = this.users[i].name;
                                    var role = this.users[i].role;
                                    this.selectedUsers.push({"uid": uid, "name": name, "role": role, "result": ""});
                                    document.getElementById("s-" + uid).checked = true;
                                }
                                document.getElementById("s-all").checked = true;
                            }
                        } else {
                            var name;
                            var role;
                            for (var i=0; i<this.users.length; i++) {
                                if (uid === this.users[i].uid) {
                                    name = this.users[i].name;
                                    role = this.users[i].role;
                                }
                            }
                            if (document.getElementById("s-" + uid).checked) {
                                this.selectedUsers.push({"uid": uid, "name": name, "role": role, "result": ""});
                                if (this.selectedUsers.length === this.users.length) {
                                    document.getElementById("s-all").checked = true;
                                }
                            } else {
                                this.selectedUsers = this.selectedUsers.filter((x) => JSON.stringify(x) !== JSON.stringify({"uid": uid, "name": name, "role": role, "result": ""}));
                                if (this.selectedUsers.length === this.users.length) {
                                    document.getElementById("s-all").checked = true;
                                }
                                document.getElementById("s-all").checked = false;
                            }
                        }
                        this.selectedUsers.sort((a, b) => a.uid - b.uid);
                    },
                    delSelectUsers() {
                        if (this.selectedUsers.length === 0) {
                            $.confirm({
                                title: "提示",
                                content: "尚未选中任何用户",
                                buttons: {
                                    ok: {
                                        text: "好"
                                    }
                                },
                                boxWidth: "25%",
                                useBootstrap: false,
                                theme: "material",
                                animationBounce: 1.5,
                            })
                            return;
                        }
                        var array = this.selectedUsers;
                        var turn = this.turn;
                        var page = this.page;
                        $.confirm({
                            title: "删除用户",
                            content: "<div style='width: 100%'>" +
                                "<h3 style='display: inline'>这将</h3>" +
                                "<h2 style='color: red;display: inline'>不可逆</h2>" +
                                "<h3 style='display: inline'>地删除以下用户</h3" +
                                "></div>" +
                                document.getElementById("s-data").innerHTML +
                                "<div>" +
                                "<h3>确认要继续执行吗?</h3>" +
                                "</div>",
                            buttons: {
                                confirm: {
                                    text: "删除",
                                    btnClass: "btn-red",
                                    action: function() {
                                        for (var i=0; i<array.length; i++) {
                                            API.deleteUser(array[i].uid, (result, args) => {
                                                var array = args[0];
                                                var i = args[1];
                                                if (result.code === 0) {
                                                    array[i].result = "删除成功";
                                                } else {
                                                    array[i].result = "删除失败(错误代码:" + result.code + ";错误原因:" + result.message + ")";
                                                }
                                            }, [array, i])
                                        }
                                        setTimeout(() => {
                                            $.alert({
                                                title: "执行结果",
                                                content: document.getElementById("s-data").innerHTML,
                                                buttons: {
                                                    ok: {
                                                        text: "好"
                                                    }
                                                },
                                                boxWidth: "25%",
                                                useBootstrap: false,
                                                theme: "material",
                                                animationBounce: 1.5
                                            })
                                            for (var i=0; i<array.length; i++) {
                                                if (array[i].result !== "删除成功") {
                                                    document.getElementById("s-" + array[i].uid).checked = false;
                                                }
                                            }
                                            turn(page);
                                        }, 2200)
                                        $.confirm({
                                            title: "等待伺服器响应",
                                            content: "请稍后...",
                                            autoClose: "ok|2000",
                                            buttons: {
                                                ok: {
                                                    text: "好"
                                                }
                                            },
                                            boxWidth: "25%",
                                            useBootstrap: false,
                                            theme: "material",
                                            animationBounce: 1.5,
                                        })
                                    }
                                },
                                cancel: {
                                    text: "取消"
                                }
                            },
                            boxWidth: "25%",
                            useBootstrap: false,
                            theme: "material",
                            animationBounce: 1.5,
                        })
                    },
                    getUserDetail(uid) {
                        app.getUserDetail(uid);
                    },
                    updUser(uid) {
                        app.updUser(uid);
                    },
                    turn(todo) {
                        this.selectedUsers = [];
                        document.getElementById("s-all").checked = false;
                        app.turn(todo);
                    }
                }
            }
        }
    })
    container.mount("#container");
    app.function1 = "Web模块加载完了, 机能正常";
    app.function2 = "EMS已就绪!!";
    window.setInterval(() => {
        setTimeout(app.getSystemInfo, 0)
    }, 1000);
</script>
</body>
</html>